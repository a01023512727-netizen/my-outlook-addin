<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ê±°ë˜ì²˜ ë„ë©”ì¸ ë§¤ì¹­</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 15px; margin: 0; background: #fff; }
    .header { color: #2b579a; font-size: 16px; font-weight: 700; border-bottom: 2px solid #2b579a; padding-bottom: 6px; margin-bottom: 12px; }
    .box { border: 1px solid #e5e5e5; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .row { margin: 6px 0; font-size: 13px; }
    .label { color:#666; display:inline-block; width: 120px; }
    .value { font-weight: 700; }
    .ok { color: #0a7a0a; }
    .warn { color: #b36b00; }
    .err { color: #b00020; white-space: pre-wrap; font-size: 12px; line-height: 1.4; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; border: 1px solid #e0e0e0; }
    th { background-color: #f3f3f3; color: #333; font-weight: bold; padding: 8px; border: 1px solid #e0e0e0; text-align: left; }
    td { padding: 8px; border: 1px solid #e0e0e0; color: #555; vertical-align: top; }
    button { padding: 8px 10px; border-radius: 8px; border: 1px solid #ddd; background: #fafafa; cursor: pointer; }
    .muted { color:#777; font-size:12px; white-space:pre-wrap; margin-top:8px; }
  </style>
</head>
<body>
  <div class="header">ğŸ“© ê±°ë˜ì²˜ ë„ë©”ì¸ ë§¤ì¹­</div>

  <div class="box">
    <div class="row"><span class="label">ë°œì‹ ì ì´ë©”ì¼</span> <span class="value" id="fromEmail">-</span></div>
    <div class="row"><span class="label">ë°œì‹ ì ë„ë©”ì¸</span> <span class="value" id="fromDomain">-</span></div>
    <div class="row"><span class="label">ìƒíƒœ</span> <span class="value" id="statusText">ëŒ€ê¸°ì¤‘</span></div>
  </div>

  <div class="box">
    <div class="row"><span class="label">data ë§¤ì¹­</span> <span class="value" id="dataStatus">-</span></div>
    <div id="dataCard"></div>
    <div class="muted" id="debug"></div>
  </div>

  <button id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
  <div class="err" id="error" style="margin-top:10px;"></div>

  <script>
    const SHEET_ID = '1DW0Rl4lDhw8lfEF0lRxXWA21WHLBSLNVrOq4eCwQG4w';
    const DATA_SHEET_NAME = 'data';

    const KEY_COL = 0;
    const NAME_COL = 1;
    const AGE_COL = 2;

    const FIRST_ROW_IS_HEADER = false;

    // âœ… í˜„ì¬ ë©”ì¼ì„ ì‹ë³„í•˜ê¸° ìœ„í•œ ê°’(ë³€ê²½ ê°ì§€/ë””ë²„ê·¸ìš©)
    let lastItemId = null;
    let lastFromEmail = null;

    document.getElementById('btnRefresh').addEventListener('click', () => run("manual"));

    if (typeof Office === 'undefined') {
      showError("Office.js ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. Outlook Add-in ì•ˆì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.");
      setStatus("Outlookì—ì„œ ì—´ì–´ì£¼ì„¸ìš”", "warn");
    } else {
      Office.onReady(async () => {
        // âœ… ë©”ì¼ì´ ë°”ë€” ë•Œë§ˆë‹¤ ìë™ ê°±ì‹ 
        try {
          Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged, (args) => {
            // ì¼ë¶€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì´ë²¤íŠ¸ ì§í›„ itemì´ ì•„ì§ ì´ì „ ê°’ì¼ ìˆ˜ ìˆì–´ ë”œë ˆì´
            setStatus("ë©”ì¼ ë³€ê²½ ê°ì§€â€¦", "warn");
            setTimeout(() => run("itemChanged"), 250);

            // ì¼ë¶€ í™˜ê²½ì—ì„œëŠ” completedê°€ ìˆì„ ìˆ˜ ìˆìŒ(ìˆìœ¼ë©´ í˜¸ì¶œ)
            try { if (args && typeof args.completed === "function") args.completed(); } catch {}
          });
        } catch (e) {
          console.error("ItemChanged handler failed:", e);
        }

        run("onReady");
      });
    }

    async function run(trigger) {
      clearError();
      clearUI();
      setStatus("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", "warn");

      try {
        const { fromEmail, fromDomain, itemId, debugInfo } = await getFromInfoAsync();

        // âœ… UI ì—…ë°ì´íŠ¸
        document.getElementById('fromEmail').textContent = fromEmail || '(ì—†ìŒ)';
        document.getElementById('fromDomain').textContent = fromDomain || '(ì—†ìŒ)';

        // âœ… ë””ë²„ê·¸/ë³€ê²½ ê°ì§€ ì •ë³´
        const changedMarks = [];
        if (lastItemId !== null && itemId && itemId !== lastItemId) changedMarks.push("itemId changed");
        if (lastFromEmail !== null && fromEmail && fromEmail !== lastFromEmail) changedMarks.push("fromEmail changed");

        lastItemId = itemId || lastItemId;
        lastFromEmail = fromEmail || lastFromEmail;

        setDebug(
          `trigger=${trigger}\n` +
          `itemId=${itemId || '(none)'}\n` +
          `changed=${changedMarks.length ? changedMarks.join(", ") : "(no diff / first run)"}\n` +
          (debugInfo ? `\nfromDebug:\n${debugInfo}\n` : "")
        );

        if (!fromDomain) {
          setStatus("ë°œì‹ ì ë„ë©”ì¸ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "warn");
          return;
        }

        // âœ… ìºì‹œ ë°©ì§€ìš© timestamp
        const url = buildGvizUrl(SHEET_ID, DATA_SHEET_NAME);
        const rows = await fetchGvizRows(url);
        const dataRows = (FIRST_ROW_IS_HEADER && rows.length) ? rows.slice(1) : rows;

        const match = findFirstMatchByDomainInA(dataRows, fromDomain);

        if (!match) {
          setDataStatus(`ë§¤ì¹­ ì—†ìŒ (${fromDomain})`, "warn");
          setStatus("data ì‹œíŠ¸ Aì—´ì—ì„œ ë„ë©”ì¸ ë§¤ì¹­ ì‹¤íŒ¨", "warn");

          const sample = dataRows.slice(0, 30).map((r, idx) => {
            const raw = String(r[KEY_COL] ?? '');
            const norm = normalizeToDomain(raw);
            return `${idx+1}. raw="${raw}" -> domain="${norm}"`;
          }).join("\n");

          setDebug(
            `trigger=${trigger}\n` +
            `itemId=${itemId || '(none)'}\n` +
            `data ì‹œíŠ¸ ë¡œë“œë¨: rows=${dataRows.length}\n\n` +
            "Aì—´ ë””ë²„ê·¸(ìƒìœ„ 30ê°œ):\n" + sample
          );
          return;
        }

        const { rowIndex, row, rawKey, normKey } = match;

        setDataStatus(`ë§¤ì¹­ë¨ (#${rowIndex+1})`, "ok");
        setStatus("í‘œì‹œ ì™„ë£Œ", "ok");

        const name = row[NAME_COL] ?? '';
        const age = row[AGE_COL] ?? '';

        document.getElementById('dataCard').innerHTML = `
          <table>
            <thead>
              <tr><th>KEY(A)</th><th>KEYâ†’ë„ë©”ì¸</th><th>ì´ë¦„(B)</th><th>ë‚˜ì´(C)</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>${escapeHtml(rawKey)}</td>
                <td>${escapeHtml(normKey)}</td>
                <td>${escapeHtml(String(name))}</td>
                <td>${escapeHtml(String(age))}</td>
              </tr>
            </tbody>
          </table>
        `;

      } catch (e) {
        console.error(e);
        showError((e && e.message) ? e.message : String(e));
        setStatus("ì—ëŸ¬ ë°œìƒ", "warn");
      }
    }

    // âœ… from ì½ê¸°ë¥¼ ìµœëŒ€í•œ í˜¸í™˜ë˜ê²Œ (ì¦‰ì‹œê°’/async ë‘˜ ë‹¤ ì§€ì›)
    async function getFromInfoAsync() {
      const item = Office?.context?.mailbox?.item;
      if (!item) throw new Error("Office.context.mailbox.item ì´ ì—†ìŠµë‹ˆë‹¤. (ë©”ì¼ ì½ê¸° í™”ë©´ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”)");

      const itemId = item.itemId || null;

      let fromEmail = '';
      let debugInfo = '';

      // 1) ê°€ëŠ¥í•˜ë©´ getAsync ìš°ì„ (í´ë¼ì´ì–¸íŠ¸/ëª¨ë“œë³„ í˜¸í™˜)
      try {
        if (item.from && typeof item.from.getAsync === 'function') {
          const r = await new Promise((resolve, reject) => {
            item.from.getAsync((asyncResult) => {
              if (asyncResult.status === Office.AsyncResultStatus.Succeeded) resolve(asyncResult.value);
              else reject(asyncResult.error || new Error("from.getAsync failed"));
            });
          });
          fromEmail = r?.emailAddress || '';
          debugInfo += `used: item.from.getAsync\nraw: ${JSON.stringify(r)}\n`;
        }
      } catch (e) {
        debugInfo += `from.getAsync error: ${e?.message || String(e)}\n`;
      }

      // 2) fallback: ê¸°ì¡´ ë°©ì‹
      if (!fromEmail) {
        fromEmail = item?.from?.emailAddress || '';
        debugInfo += `used: item.from.emailAddress fallback\n`;
      }

      const fromDomain = normalizeToDomain(fromEmail);
      return { fromEmail, fromDomain, itemId, debugInfo };
    }

    function buildGvizUrl(sheetId, sheetName) {
      const base = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      return `${base}&_ts=${Date.now()}`;
    }

    async function fetchGvizRows(url) {
      const res = await fetch(url, { method: 'GET', redirect: 'follow', cache: 'no-store' });

      if (!res.ok) {
        const body = await safeText(res);
        throw new Error(`Sheet fetch failed: HTTP ${res.status} ${res.statusText}\n\nì‘ë‹µ ì¼ë¶€:\n${(body || '').slice(0, 300)}`);
      }

      const text = await res.text();

      if (!text.includes("google.visualization") && !text.startsWith("/*O_o*/")) {
        throw new Error(
          "gviz JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (ë¡œê·¸ì¸/ê¶Œí•œ/ì°¨ë‹¨ ê°€ëŠ¥)\n\nì‘ë‹µ ì¼ë¶€:\n" +
          text.slice(0, 300)
        );
      }

      const jsonText = text.substring(47).slice(0, -2);
      const json = JSON.parse(jsonText);

      const rows = (json.table.rows || []).map(r => (r.c || []).map(cell => {
        if (!cell) return '';
        return (cell.f != null ? cell.f : cell.v) ?? '';
      }));

      return rows;
    }

    async function safeText(res) {
      try { return await res.text(); } catch { return ""; }
    }

    function normalizeToDomain(value) {
      if (value == null) return '';
      let s = String(value);

      s = s.replace(/\u00A0/g, ' ').trim().toLowerCase();
      s = s.replace(/^https?:\/\//, '');
      s = s.replace(/,.*$/, '');
      s = s.replace(/\/.*$/, '');
      s = s.replace(/^[.@]+/, '');

      if (s.includes('@')) {
        s = s.slice(s.lastIndexOf('@') + 1).trim();
      }

      return s;
    }

    function findFirstMatchByDomainInA(rows, fromDomain) {
      const d = normalizeToDomain(fromDomain);

      for (let i = 0; i < rows.length; i++) {
        const rawKey = String(rows[i][KEY_COL] ?? '');
        const keyDomain = normalizeToDomain(rawKey);

        if (!keyDomain) continue;

        if (keyDomain === d) {
          return { rowIndex: i, row: rows[i], rawKey, normKey: keyDomain };
        }

        if (d.endsWith('.' + keyDomain) || keyDomain.endsWith('.' + d)) {
          return { rowIndex: i, row: rows[i], rawKey, normKey: keyDomain };
        }
      }

      return null;
    }

    function setStatus(text, tone) {
      const el = document.getElementById('statusText');
      el.textContent = text;
      el.classList.remove('ok', 'warn');
      if (tone) el.classList.add(tone);
    }

    function setDataStatus(text, tone) {
      const el = document.getElementById('dataStatus');
      el.textContent = text;
      el.classList.remove('ok', 'warn');
      if (tone) el.classList.add(tone);
    }

    function setDebug(text) {
      document.getElementById('debug').textContent = text || '';
    }

    function clearUI() {
      document.getElementById('dataCard').innerHTML = '';
      document.getElementById('debug').textContent = '';
      document.getElementById('dataStatus').textContent = '-';
    }

    function showError(msg) {
      document.getElementById('error').textContent = msg;
    }

    function clearError() {
      document.getElementById('error').textContent = '';
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
