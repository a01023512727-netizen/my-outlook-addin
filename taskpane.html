<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ê±°ë˜ì²˜ ë„ë©”ì¸ ì¡°íšŒ</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 15px; margin: 0; background: #fff; }
    .header { color: #2b579a; font-size: 16px; font-weight: 700; border-bottom: 2px solid #2b579a; padding-bottom: 6px; margin-bottom: 12px; }
    .box { border: 1px solid #e5e5e5; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .row { margin: 6px 0; font-size: 13px; }
    .label { color:#666; display:inline-block; width: 120px; }
    .value { font-weight: 700; }
    .ok { color: #0a7a0a; }
    .warn { color: #b36b00; }
    .err { color: #b00020; white-space: pre-wrap; font-size: 12px; line-height: 1.4; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; border: 1px solid #e0e0e0; }
    th { background-color: #f3f3f3; color: #333; font-weight: bold; padding: 8px; border: 1px solid #e0e0e0; text-align: left; }
    td { padding: 8px; border: 1px solid #e0e0e0; color: #555; vertical-align: top; }
    tr:nth-child(even) { background-color: #fafafa; }

    button { padding: 8px 10px; border-radius: 8px; border: 1px solid #ddd; background: #fafafa; cursor: pointer; }
    .muted { color:#777; font-size:12px; white-space:pre-wrap; margin-top:8px; }

    .calc { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
    .calc input { padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; width: 160px; }
    .pill { padding: 6px 10px; border-radius: 999px; border: 1px solid #e5e5e5; background: #fafafa; font-size: 12px; }
  </style>
</head>
<body>
  <div class="header">ğŸ“© ê±°ë˜ì²˜ ë„ë©”ì¸ ì¡°íšŒ</div>

  <div class="box">
    <div class="row"><span class="label">ë°œì‹ ì ì´ë©”ì¼</span> <span class="value" id="fromEmail">-</span></div>
    <div class="row"><span class="label">ë°œì‹ ì ë„ë©”ì¸</span> <span class="value" id="fromDomain">-</span></div>
    <div class="row"><span class="label">ìƒíƒœ</span> <span class="value" id="statusText">ëŒ€ê¸°ì¤‘</span></div>
  </div>

  <div class="box">
    <div class="row"><span class="label">ì¡°íšŒ ê²°ê³¼</span> <span class="value" id="resultStatus">-</span></div>
    <div id="resultTable"></div>

    <div id="calcBox" style="display:none;">
      <div class="calc">
        <span class="pill" id="feePill">ìˆ˜ìˆ˜ë£Œ: -</span>
        <input id="amountInput" placeholder="ê¸ˆì•¡ ì…ë ¥ (ì˜ˆ: 10000)" inputmode="numeric" />
        <span class="pill" id="resultPill">ê²°ê³¼: -</span>
      </div>
      <div class="muted" id="calcHint"></div>
    </div>

    <div class="muted" id="debug"></div>
  </div>

  <button id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
  <div class="err" id="error" style="margin-top:10px;"></div>

  <script>
    // âœ… ë„ˆì˜ Apps Script ì›¹ì•± URL
    const SCRIPT_API_URL = "https://script.google.com/macros/s/AAAAAAA/exec";

    // âœ… ìˆ˜ìˆ˜ë£Œ ì»¬ëŸ¼ëª… í›„ë³´(ì‹œíŠ¸ í—¤ë”ê°€ ë­ê°€ ë˜ë“  ìë™ íƒìƒ‰)
    const FEE_FIELD_CANDIDATES = ["ìˆ˜ìˆ˜ë£Œ", "fee", "commission", "rate", "ì»¤ë¯¸ì…˜"];

    let currentFeeRate = null; // 0.03 ê°™ì€ ìˆ«ì
    let currentRecord = null;

    document.getElementById('btnRefresh').addEventListener('click', run);
    document.getElementById('amountInput').addEventListener('input', onAmountChange);

    Office.onReady(() => {
      try {
        Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged, () => run());
      } catch (e) {
        console.error("ItemChanged handler failed:", e);
      }
      run();
    });

    async function run() {
      clearError();
      clearResult();
      setDebug("");
      hideCalc();
      setStatus("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", "warn");
      setResultStatus("-");

      try {
        const { fromEmail, fromDomain } = getFromInfo();
        document.getElementById('fromEmail').textContent = fromEmail || '(ì—†ìŒ)';
        document.getElementById('fromDomain').textContent = fromDomain || '(ì—†ìŒ)';

        if (!fromDomain) {
          setStatus("ë°œì‹ ì ë„ë©”ì¸ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "warn");
          return;
        }

        const json = await callScriptJsonp(fromDomain);
        setDebug("ì‘ë‹µ:\n" + JSON.stringify(json, null, 2));

        if (!json.allowed) {
          setResultStatus("ê¶Œí•œ/ë“±ë¡ ì—†ìŒ", "warn");
          setStatus("domain ì‹œíŠ¸ì— ë“±ë¡ë˜ì§€ ì•Šì€ ë„ë©”ì¸ì…ë‹ˆë‹¤.", "warn");
          return;
        }

        if (json.matched === false) {
          setResultStatus("ë“±ë¡ë¨ / data ë§¤ì¹­ ì—†ìŒ", "warn");
          setStatus("domainì—ëŠ” ìˆì§€ë§Œ dataì—ëŠ” ë§¤ì¹­ì´ ì—†ìŠµë‹ˆë‹¤.", "warn");
          return;
        }

        if (!json.record || typeof json.record !== "object") {
          setResultStatus("ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜", "warn");
          setStatus("Apps Script ì‘ë‹µì— recordê°€ ì—†ìŠµë‹ˆë‹¤.", "warn");
          return;
        }

        currentRecord = json.record;

        setResultStatus("ë§¤ì¹­ë¨ âœ…", "ok");
        setStatus("í‘œì‹œ ì™„ë£Œ", "ok");

        renderDynamicRecord(json.record);

        // ìˆ˜ìˆ˜ë£Œ ì°¾ê¸° + ê³„ì‚° ë°•ìŠ¤ í™œì„±í™”
        const feeRaw = findFeeValue(json.record);
        const feeRate = parsePercentToRate(feeRaw);
        if (feeRate != null) {
          currentFeeRate = feeRate;
          showCalc(feeRaw, feeRate);
          // ì…ë ¥ê°’ ìœ ì§€í•œ ì±„ ì¬ê³„ì‚°
          onAmountChange();
        }

      } catch (e) {
        console.error(e);
        showError((e && e.message) ? e.message : String(e));
        setStatus("ì—ëŸ¬ ë°œìƒ", "warn");
      }
    }

    function getFromInfo() {
      const item = Office?.context?.mailbox?.item;
      if (!item) throw new Error("Office.context.mailbox.item ì´ ì—†ìŠµë‹ˆë‹¤. (ë©”ì¼ ì½ê¸° í™”ë©´ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”)");
      const fromEmail = item?.from?.emailAddress || '';
      const fromDomain = normalizeToDomain(fromEmail);
      return { fromEmail, fromDomain };
    }

    function normalizeToDomain(value) {
      if (value == null) return '';
      let s = String(value);
      s = s.replace(/\u00A0/g, ' ').trim().toLowerCase();
      s = s.replace(/^https?:\/\//, '');
      s = s.replace(/,.*$/, '');
      s = s.replace(/\/.*$/, '');
      s = s.replace(/^[.@]+/, '');
      if (s.includes('@')) s = s.slice(s.lastIndexOf('@') + 1).trim();
      return s;
    }

    // âœ… JSONP í˜¸ì¶œ
    function callScriptJsonp(domain) {
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Math.random().toString(36).slice(2);
        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error("Apps Script JSONP timeout"));
        }, 12000);

        window[cbName] = (data) => { cleanup(); resolve(data); };

        const url =
          `${SCRIPT_API_URL}?domain=${encodeURIComponent(domain)}` +
          `&callback=${encodeURIComponent(cbName)}` +
          `&_ts=${Date.now()}`;

        const script = document.createElement("script");
        script.src = url;
        script.async = true;
        script.onerror = () => { cleanup(); reject(new Error("Apps Script JSONP load failed")); };

        document.head.appendChild(script);

        function cleanup() {
          clearTimeout(timeout);
          try { delete window[cbName]; } catch {}
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }
      });
    }

    // âœ… recordë¥¼ â€œë™ì â€ í•­ëª©/ê°’ í…Œì´ë¸”ë¡œ ë Œë”
    function renderDynamicRecord(record) {
      const entries = Object.entries(record);

      const html = `
        <table>
          <thead><tr><th>í•­ëª©</th><th>ê°’</th></tr></thead>
          <tbody>
            ${entries.map(([k, v]) => `
              <tr>
                <td>${escapeHtml(k)}</td>
                <td>${escapeHtml(formatValue(v))}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      document.getElementById('resultTable').innerHTML = html;
    }

    function formatValue(v) {
      if (v == null) return "";
      if (typeof v === "number") return String(v);
      return String(v);
    }

    // âœ… ìˆ˜ìˆ˜ë£Œ ì»¬ëŸ¼ ìë™ ì°¾ê¸°
    function findFeeValue(record) {
      // 1) í›„ë³´ í‚¤ë¡œ ì§ì ‘ íƒìƒ‰ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
      const keys = Object.keys(record);
      for (const cand of FEE_FIELD_CANDIDATES) {
        const hit = keys.find(k => String(k).trim().toLowerCase() === cand.toLowerCase());
        if (hit) return record[hit];
      }

      // 2) í‚¤ì— "ìˆ˜ìˆ˜ë£Œ/fee/commission" í¬í•¨í•˜ë©´ ê·¸ê²ƒë„ í—ˆìš©
      const loose = keys.find(k => {
        const kk = String(k).trim().toLowerCase();
        return kk.includes("ìˆ˜ìˆ˜ë£Œ") || kk.includes("fee") || kk.includes("commission") || kk.includes("ì»¤ë¯¸ì…˜");
      });
      if (loose) return record[loose];

      return null;
    }

    // "3%" / "0.03" / "3" -> 0.03 ë¡œ ë³€í™˜
    function parsePercentToRate(value) {
      if (value == null) return null;

      let s = String(value).trim();

      if (!s) return null;

      // "3%" í˜•íƒœ
      if (s.includes("%")) {
        s = s.replace("%", "").trim();
        const n = Number(s.replace(/,/g, ""));
        if (Number.isFinite(n)) return n / 100;
        return null;
      }

      // ìˆ«ì
      const n = Number(s.replace(/,/g, ""));
      if (!Number.isFinite(n)) return null;

      // 0.03 ì²˜ëŸ¼ 1 ì´í•˜ì´ë©´ ì´ë¯¸ rateë¡œ íŒë‹¨
      if (n <= 1) return n;

      // 3 ì²˜ëŸ¼ 1 ì´ˆê³¼ì´ë©´ í¼ì„¼íŠ¸ë¡œ íŒë‹¨
      return n / 100;
    }

    function showCalc(feeRaw, feeRate) {
      document.getElementById("calcBox").style.display = "block";
      document.getElementById("feePill").textContent = `ìˆ˜ìˆ˜ë£Œ: ${feeRaw} (rate=${feeRate})`;
      document.getElementById("calcHint").textContent = "ê¸ˆì•¡ì„ ì…ë ¥í•˜ë©´ ìˆ˜ìˆ˜ë£Œ ê¸ˆì•¡ì„ ìë™ ê³„ì‚°í•©ë‹ˆë‹¤.";
      currentFeeRate = feeRate;
    }

    function hideCalc() {
      document.getElementById("calcBox").style.display = "none";
      currentFeeRate = null;
      document.getElementById("feePill").textContent = "ìˆ˜ìˆ˜ë£Œ: -";
      document.getElementById("resultPill").textContent = "ê²°ê³¼: -";
      document.getElementById("calcHint").textContent = "";
    }

    function onAmountChange() {
      const input = document.getElementById("amountInput").value || "";
      const amount = parseMoney(input);

      if (currentFeeRate == null || amount == null) {
        document.getElementById("resultPill").textContent = "ê²°ê³¼: -";
        return;
      }

      const feeAmount = Math.round(amount * currentFeeRate);
      document.getElementById("resultPill").textContent =
        `ê²°ê³¼: ${formatMoney(feeAmount)} (ì…ë ¥ ${formatMoney(amount)} Ã— ${(currentFeeRate*100).toFixed(2)}%)`;
    }

    function parseMoney(text) {
      const s = String(text).trim();
      if (!s) return null;
      const n = Number(s.replace(/,/g, ""));
      if (!Number.isFinite(n)) return null;
      return n;
    }

    function formatMoney(n) {
      try { return Number(n).toLocaleString("ko-KR"); }
      catch { return String(n); }
    }

    function setStatus(text, tone) {
      const el = document.getElementById('statusText');
      el.textContent = text;
      el.classList.remove('ok', 'warn');
      if (tone) el.classList.add(tone);
    }

    function setResultStatus(text, tone) {
      const el = document.getElementById('resultStatus');
      el.textContent = text;
      el.classList.remove('ok', 'warn');
      if (tone) el.classList.add(tone);
    }

    function clearResult() {
      document.getElementById('resultTable').innerHTML = '';
    }

    function setDebug(text) {
      document.getElementById('debug').textContent = text || '';
    }

    function showError(msg) {
      document.getElementById('error').textContent = msg;
    }

    function clearError() {
      document.getElementById('error').textContent = '';
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
