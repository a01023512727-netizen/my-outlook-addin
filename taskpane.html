<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ê±°ë˜ì²˜ ë„ë©”ì¸ ë§¤ì¹­</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 15px; margin: 0; background: #fff; }
    .header { color: #2b579a; font-size: 16px; font-weight: 700; border-bottom: 2px solid #2b579a; padding-bottom: 6px; margin-bottom: 12px; }
    .box { border: 1px solid #e5e5e5; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .row { margin: 6px 0; font-size: 13px; }
    .label { color:#666; display:inline-block; width: 120px; }
    .value { font-weight: 700; }
    .ok { color: #0a7a0a; }
    .warn { color: #b36b00; }
    .err { color: #b00020; white-space: pre-wrap; font-size: 12px; line-height: 1.4; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; border: 1px solid #e0e0e0; }
    th { background-color: #f3f3f3; color: #333; font-weight: bold; padding: 8px; border: 1px solid #e0e0e0; text-align: left; }
    td { padding: 8px; border: 1px solid #e0e0e0; color: #555; }

    button { padding: 8px 10px; border-radius: 8px; border: 1px solid #ddd; background: #fafafa; cursor: pointer; }
    .muted { color:#777; font-size:12px; white-space:pre-wrap; margin-top:8px; }
  </style>
</head>
<body>
  <div class="header">ğŸ“© ê±°ë˜ì²˜ ë„ë©”ì¸ ë§¤ì¹­</div>

  <div class="box">
    <div class="row"><span class="label">ë°œì‹ ì ì´ë©”ì¼</span> <span class="value" id="fromEmail">-</span></div>
    <div class="row"><span class="label">ë°œì‹ ì ë„ë©”ì¸</span> <span class="value" id="fromDomain">-</span></div>
    <div class="row"><span class="label">ìƒíƒœ</span> <span class="value" id="statusText">ëŒ€ê¸°ì¤‘</span></div>
  </div>

  <div class="box">
    <div class="row"><span class="label">domain ì‹œíŠ¸</span> <span class="value" id="domainStatus">-</span></div>
  </div>

  <div class="box">
    <div class="row"><span class="label">data ì‹œíŠ¸</span> <span class="value" id="dataStatus">-</span></div>
    <div id="dataTable"></div>
    <div class="muted" id="debug"></div>
  </div>

  <button id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
  <div class="err" id="error" style="margin-top:10px;"></div>

  <script>
    const SHEET_ID = '1DW0Rl4lDhw8lfEF0lRxXWA21WHLBSLNVrOq4eCwQG4w';

    const DOMAIN_SHEET_NAME = 'domain';
    const DATA_SHEET_NAME = 'data';

    const DOMAIN_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(DOMAIN_SHEET_NAME)}`;
    const DATA_URL   = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(DATA_SHEET_NAME)}`;

    // domain ì‹œíŠ¸: ì˜ˆ) [ê±°ë˜ì²˜ëª…, ë„ë©”ì¸] -> ë„ë©”ì¸=1
    const DOMAIN_COL_INDEX_IN_DOMAIN_SHEET = 1;

    // data ì‹œíŠ¸: Aì—´ì— "a@tidesquare.com" ê°™ì€ ê°’ì´ ë“¤ì–´ìˆìŒ -> A=0
    const KEY_COL_INDEX_IN_DATA_SHEET = 0;

    // ì²« í–‰ì´ í—¤ë”ë©´ true
    const FIRST_ROW_IS_HEADER = true;

    document.getElementById('btnRefresh').addEventListener('click', run);

    if (typeof Office === 'undefined') {
      showError("Office.js ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. Outlook Add-in ì•ˆì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.");
      setStatus("Outlookì—ì„œ ì—´ì–´ì£¼ì„¸ìš”", "warn");
    } else {
      Office.onReady(() => {
        if (!isOutlookContextReady()) {
          setStatus("Outlook ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„ ì¤‘...", "warn");
          setTimeout(() => {
            if (isOutlookContextReady()) run();
            else {
              showError("Office.context.mailbox.item ì´ ì—†ìŠµë‹ˆë‹¤. ë©”ì¼ ì½ê¸° í™”ë©´ì—ì„œ Add-inì„ ì—´ì–´ì£¼ì„¸ìš”.");
              setStatus("Outlook ì»¨í…ìŠ¤íŠ¸ ì—†ìŒ", "warn");
            }
          }, 600);
          return;
        }
        run();
      });
    }

    function isOutlookContextReady() {
      return !!(Office && Office.context && Office.context.mailbox && Office.context.mailbox.item);
    }

    async function run() {
      clearError();
      clearData();
      setDebug("");
      setStatus("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", "warn");
      setDomainStatus("-");
      setDataStatus("-");

      try {
        const { fromEmail, fromDomain } = getFromInfo();
        document.getElementById('fromEmail').textContent = fromEmail || '(ì—†ìŒ)';
        document.getElementById('fromDomain').textContent = fromDomain || '(ì—†ìŒ)';

        if (!fromDomain) {
          setStatus("ë°œì‹ ì ë„ë©”ì¸ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "warn");
          return;
        }

        // 1) domain ì‹œíŠ¸ì—ì„œ "ë„ë©”ì¸ ë“±ë¡ ì—¬ë¶€" ì²´í¬
        const domainTable = await fetchGvizTable(DOMAIN_URL);
        let domainRows = domainTable.rows;
        if (FIRST_ROW_IS_HEADER && domainRows.length) domainRows = domainRows.slice(1);

        const allowed = !!findRowByDomain(domainRows, fromDomain, DOMAIN_COL_INDEX_IN_DOMAIN_SHEET);
        if (!allowed) {
          setDomainStatus(`ë¯¸ë“±ë¡ (${fromDomain})`, "warn");
          setStatus("ë“±ë¡ë˜ì§€ ì•Šì€ ë„ë©”ì¸ì´ë¼ data í‘œì‹œë¥¼ ìƒëµí•©ë‹ˆë‹¤.", "warn");
          return;
        }
        setDomainStatus(`ë“±ë¡ë¨ (${fromDomain})`, "ok");

        // 2) data ì‹œíŠ¸ì—ì„œ "Aì—´ ê°’(ì´ë©”ì¼/ë„ë©”ì¸)" -> ë„ë©”ì¸ìœ¼ë¡œ ì •ê·œí™” í›„ ë§¤ì¹­
        const dataTable = await fetchGvizTable(DATA_URL);
        let dataRows = dataTable.rows;
        if (FIRST_ROW_IS_HEADER && dataRows.length) dataRows = dataRows.slice(1);

        // ë””ë²„ê·¸: ìƒìœ„ 10ê°œ key ê°’ì´ ì–´ë–»ê²Œ ë„ë©”ì¸ìœ¼ë¡œ ë³€í™˜ë˜ëŠ”ì§€ ë³´ì—¬ì¤Œ
        const sample = dataRows.slice(0, 10).map(r => {
          const raw = String(r[KEY_COL_INDEX_IN_DATA_SHEET] ?? '');
          const norm = normalizeToDomain(raw);
          return `- raw: "${raw}"  -> domain: "${norm}"`;
        }).join("\n");
        setDebug("data ì‹œíŠ¸ Aì—´ ìƒ˜í”Œ(ìƒìœ„ 10ê°œ) ì •ê·œí™”:\n" + sample);

        const matchedDataRow = findRowByDomainUsingKeyCol(dataRows, fromDomain, KEY_COL_INDEX_IN_DATA_SHEET);

        if (!matchedDataRow) {
          setDataStatus(`ë§¤ì¹­ ì—†ìŒ (${fromDomain})`, "warn");
          setStatus("data ì‹œíŠ¸ Aì—´ ê°’ì´ ì´ë©”ì¼/ë„ë©”ì¸ì´ì§€ë§Œ, ë„ë©”ì¸ ë³€í™˜ í›„ì—ë„ ì¼ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.", "warn");
          return;
        }

        setDataStatus(`ë§¤ì¹­ë¨ (${fromDomain})`, "ok");
        renderSingleRowTable(dataTable.headers, matchedDataRow);
        setStatus("í‘œì‹œ ì™„ë£Œ", "ok");

      } catch (e) {
        console.error(e);
        showError((e && e.message) ? e.message : String(e));
        setStatus("ì—ëŸ¬ ë°œìƒ", "warn");
      }
    }

    function getFromInfo() {
      const item = Office?.context?.mailbox?.item;
      if (!item) throw new Error("Office.context.mailbox.item ì´ ì—†ìŠµë‹ˆë‹¤.");

      const fromEmail = item?.from?.emailAddress || '';
      const fromDomain = normalizeToDomain(fromEmail); // ì´ë©”ì¼ì„ ë„ë©”ì¸ìœ¼ë¡œ
      return { fromEmail, fromDomain };
    }

    // âœ… ì…ë ¥ì´ ì´ë©”ì¼ì´ë“  ë„ë©”ì¸ì´ë“  "ë„ë©”ì¸"ìœ¼ë¡œ ë³€í™˜
    function normalizeToDomain(value) {
      if (value == null) return '';
      let s = String(value);

      // nbsp ì œê±° + trim
      s = s.replace(/\u00A0/g, ' ').trim().toLowerCase();

      // í”„ë¡œí† ì½œ ì œê±°
      s = s.replace(/^https?:\/\//, '');

      // ì½¤ë§ˆ/ìŠ¬ë˜ì‹œ ì´í›„ ì œê±°
      s = s.replace(/,.*$/, '');
      s = s.replace(/\/.*$/, '');

      // ì•ì— @ . ì œê±°
      s = s.replace(/^[.@]+/, '');

      // ì´ë©”ì¼ì´ë©´ @ ë’¤ë§Œ ì·¨í•¨
      if (s.includes('@')) {
        s = s.slice(s.lastIndexOf('@') + 1).trim();
      }

      return s;
    }

    async function fetchGvizTable(url) {
      const res = await fetch(url, { method: 'GET', redirect: 'follow', cache: 'no-store' });
      if (!res.ok) throw new Error(`Sheet fetch failed: HTTP ${res.status} ${res.statusText}`);

      const text = await res.text();
      const jsonText = text.substring(47).slice(0, -2);
      const json = JSON.parse(jsonText);

      const headers = (json.table.cols || []).map((c, idx) => ({ label: c.label || `COL${idx + 1}` }));
      const rows = (json.table.rows || []).map(r => (r.c || []).map(cell => {
        if (!cell) return '';
        return (cell.f != null ? cell.f : cell.v) ?? '';
      }));

      return { headers, rows };
    }

    // domain ì‹œíŠ¸ ìª½: ì…€ ê°’ì´ ë„ë©”ì¸ì´ë¼ê³  ê°€ì •í•˜ì§€ë§Œ ê·¸ë˜ë„ ë„ë©”ì¸ ì •ê·œí™” ì ìš©
    function findRowByDomain(rows, domain, domainColIndex) {
      const d = normalizeToDomain(domain);
      for (const row of rows) {
        const cell = normalizeToDomain(row[domainColIndex]);
        if (!cell) continue;
        if (cell === d) return row;
        if (d.endsWith('.' + cell)) return row;  // mail.test.com -> test.com
        if (cell.endsWith('.' + d)) return row;
      }
      return null;
    }

    // data ì‹œíŠ¸ ìª½: Aì—´ key(ì´ë©”ì¼/ë„ë©”ì¸)ë¥¼ ë„ë©”ì¸ìœ¼ë¡œ ë³€í™˜í•´ì„œ ë¹„êµ
    function findRowByDomainUsingKeyCol(rows, domain, keyColIndex) {
      const d = normalizeToDomain(domain);
      for (const row of rows) {
        const keyRaw = row[keyColIndex];
        const keyDomain = normalizeToDomain(keyRaw);
        if (!keyDomain) continue;

        if (keyDomain === d) return row;
        if (d.endsWith('.' + keyDomain)) return row;
        if (keyDomain.endsWith('.' + d)) return row;
      }
      return null;
    }

    function renderSingleRowTable(headers, row) {
      const ths = headers.map(h => `<th>${escapeHtml(h.label || '')}</th>`).join('');
      const tds = row.map(v => `<td>${escapeHtml(String(v ?? ''))}</td>`).join('');

      document.getElementById('dataTable').innerHTML = `
        <table>
          <thead><tr>${ths}</tr></thead>
          <tbody><tr>${tds}</tr></tbody>
        </table>
      `;
    }

    function clearData() {
      document.getElementById('dataTable').innerHTML = '';
    }

    function setStatus(text, tone) {
      const el = document.getElementById('statusText');
      el.textContent = text;
      el.classList.remove('ok', 'warn');
      if (tone) el.classList.add(tone);
    }

    function setDomainStatus(text, tone) {
      const el = document.getElementById('domainStatus');
      el.textContent = text;
      el.classList.remove('ok', 'warn');
      if (tone) el.classList.add(tone);
    }

    function setDataStatus(text, tone) {
      const el = document.getElementById('dataStatus');
      el.textContent = text;
      el.classList.remove('ok', 'warn');
      if (tone) el.classList.add(tone);
    }

    function setDebug(text) {
      document.getElementById('debug').textContent = text || '';
    }

    function showError(msg) {
      document.getElementById('error').textContent = msg;
    }

    function clearError() {
      document.getElementById('error').textContent = '';
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
