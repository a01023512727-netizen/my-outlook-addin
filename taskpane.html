<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ê±°ë˜ì²˜ ë„ë©”ì¸ ë§¤ì¹­</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 15px; margin: 0; background: #fff; }
    .header { color: #2b579a; font-size: 16px; font-weight: 800; border-bottom: 2px solid #2b579a; padding-bottom: 6px; margin-bottom: 12px; }

    .box { border: 1px solid #e5e5e5; border-radius: 12px; padding: 12px; margin-bottom: 12px; background: #fff; }
    .row { margin: 6px 0; font-size: 13px; display:flex; gap:10px; align-items: baseline; }
    .label { color:#666; width: 120px; flex: 0 0 120px; }
    .value { font-weight: 800; word-break: break-all; }
    .ok { color: #0a7a0a; }
    .warn { color: #b36b00; }
    .err { color: #b00020; white-space: pre-wrap; font-size: 12px; line-height: 1.4; }

    button { padding: 8px 10px; border-radius: 10px; border: 1px solid #ddd; background: #fafafa; cursor: pointer; font-weight: 700; }
    button:hover { background:#f3f3f3; }

    .muted { color:#777; font-size:12px; white-space:pre-wrap; margin-top:8px; }

    /* ì¹´ë“œ */
    .matchCard {
      border: 1px solid #e6e6e6;
      border-radius: 14px;
      padding: 12px;
      margin-top: 10px;
      background: linear-gradient(180deg, #fbfbff 0%, #ffffff 70%);
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    }
    .kvGrid { display:grid; grid-template-columns: 1fr; gap: 10px; }
    .kvItem { border: 1px solid #ededed; border-radius: 12px; padding: 5px; background: #fff; }
    .kvTitle { font-size: 12px; color: #555; font-weight: 900; display:flex; align-items:center; gap:8px; margin-bottom: 6px; }
    .kvValue { font-size: 13px; color: #222; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }

    .dot { width: 8px; height: 8px; border-radius: 999px; display:inline-block; background: #2b579a; }
    .dot.green { background:#0a7a0a; }
    .dot.orange { background:#b36b00; }
    .dot.red { background:#b00020; }
    .dot.gray { background:#666; }

    /* ìˆ˜ìˆ˜ë£Œ ë¼ì¸: ê°„ê²© ì¤„ì´ê¸° */
    .feeLine {
      display:flex;
      align-items:center;
      gap: 8px;              /* âœ… ê°„ê²© ì¢ê²Œ */
      flex-wrap: wrap;
      margin-top: 4px;       /* âœ… ìœ„ ì—¬ë°± ì¤„ì´ê¸° */
    }
    .feePill {
      display:inline-flex; align-items:center; gap:6px;
      border: 1px solid #e3e8ff;
      background:#f4f6ff;
      color:#1f3b8a;
      border-radius: 999px;
      padding: 4px 8px;      /* âœ… íŒ¨ë”© ì¤„ì´ê¸° */
      font-size: 12px;
      font-weight: 900;
      line-height: 1.2;
    }
    .feeInput {
      width: 140px;          /* âœ… ë„ˆë¬´ ê¸¸ì§€ ì•Šê²Œ */
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 7px 10px;
      font-size: 13px;
      outline: none;
    }
    .feeInput:focus { border-color:#2b579a; box-shadow: 0 0 0 3px rgba(43,87,154,0.12); }
    .feeResultInline {
      font-weight: 900;
      color:#2b579a;
      padding: 2px 0;
    }
    .feeHint { color:#666; font-size:12px; }

    .companyName {
      font-size: 14px;
      font-weight: 900;
      color:#1f2a44;
    }
  </style>
</head>
<body>
  <div class="header">ğŸ“© ê±°ë˜ì²˜ ë„ë©”ì¸ ë§¤ì¹­</div>

  <!-- âœ… 1) ìƒíƒœ ì¤„ ì œê±° -->
  <div class="box">
    <div class="row"><span class="label">ë°œì‹ ì ì´ë©”ì¼</span> <span class="value" id="fromEmail">-</span></div>
    <div class="row"><span class="label">ë°œì‹ ì ë„ë©”ì¸</span> <span class="value" id="fromDomain">-</span></div>
  </div>

  <div class="box">
    <div class="row"><span class="label">ê±°ë˜ì²˜ ë§¤ì¹­</span> <span class="value" id="dataStatus">-</span></div>
    <div id="dataCard"></div>
    <div class="muted" id="debug"></div>
  </div>

  <button id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
  <div class="err" id="error" style="margin-top:10px;"></div>

  <script>
    const SHEET_ID = '1DW0Rl4lDhw8lfEF0lRxXWA21WHLBSLNVrOq4eCwQG4w';
    const DATA_SHEET_NAME = 'data';

    // A=KEY(ì´ë©”ì¼/ë„ë©”ì¸)
    const KEY_COL = 0;

    // âœ… B~F ìˆœì„œëŒ€ë¡œ
    const COMPANY_COL = 1;  // ê±°ë˜ì²˜ëª… (B)
    const FEE_COL = 2;      // ìˆ˜ìˆ˜ë£Œ (C) (ì˜ˆ: 3% ë˜ëŠ” 3)
    const NOTE_COL = 3;     // íŠ¹ì´ì‚¬í•­ (D)
    const BAN_COL = 4;      // ê¸ˆì§€ì‚¬í•­ (E)
    const MEMO_COL = 5;     // ë¹„ê³  (F)

    const FIRST_ROW_IS_HEADER = false;

    document.getElementById('btnRefresh').addEventListener('click', run);

    if (typeof Office === 'undefined') {
      showError("Office.js ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. Outlook Add-in ì•ˆì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.");
    } else {
      Office.onReady(async () => {
        try {
          Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged, () => run());
        } catch (e) {
          console.error("ItemChanged handler failed:", e);
        }
        run();
      });
    }

    async function run() {
      clearError();
      clearUI();

      try {
        const { fromEmail, fromDomain } = getFromInfo();
        document.getElementById('fromEmail').textContent = fromEmail || '(ì—†ìŒ)';
        document.getElementById('fromDomain').textContent = fromDomain || '(ì—†ìŒ)';

        if (!fromDomain) {
          setDataStatus("ë°œì‹ ì ë„ë©”ì¸ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "warn");
          return;
        }

        const url = buildGvizUrl(SHEET_ID, DATA_SHEET_NAME);
        const rows = await fetchGvizRows(url);
        const dataRows = (FIRST_ROW_IS_HEADER && rows.length) ? rows.slice(1) : rows;

        const match = findFirstMatchByDomainInA(dataRows, fromDomain);

        if (!match) {
          setDataStatus(`ë§¤ì¹­ ì—†ìŒ (${fromDomain})`, "warn");
          setDebug(`data ì‹œíŠ¸ ë¡œë“œë¨: rows=${dataRows.length}`);
          return;
        }

        const { rowIndex, row } = match;
        setDataStatus(`ë§¤ì¹­ë¨ (#${rowIndex+1})`, "ok");

        const company = String(row[COMPANY_COL] ?? '').trim();
        const feeRaw  = String(row[FEE_COL] ?? '').trim();
        const note    = String(row[NOTE_COL] ?? '').trim();
        const ban     = String(row[BAN_COL] ?? '').trim();
        const memo    = String(row[MEMO_COL] ?? '').trim();

        const feePct = parsePercent(feeRaw); // 3 => 0.03
        const feeLabel = (feePct != null) ? formatPercent(feePct) : (feeRaw || '-');

        // âœ… 2) ê±°ë˜ì²˜ëª…/ìˆ˜ìˆ˜ë£Œ/íŠ¹ì´ì‚¬í•­/ê¸ˆì§€ì‚¬í•­/ë¹„ê³  ìˆœìœ¼ë¡œ í‘œì‹œ
        document.getElementById('dataCard').innerHTML = `
          <div class="matchCard">
            <div class="kvGrid">
              <div class="kvItem">
                <div class="kvTitle"><span class="dot"></span> ê±°ë˜ì²˜ëª…</div>
                <div class="kvValue"><div class="companyName">${escapeHtml(company || '-')}</div></div>
              </div>

              <div class="kvItem">
                <div class="kvTitle"><span class="dot green"></span> ìˆ˜ìˆ˜ë£Œ</div>
                <div class="kvValue">
                  <div class="feeLine">
                    <span class="feePill">ìˆ˜ìˆ˜ë£Œìœ¨ ${escapeHtml(feeLabel || '-')}</span>
                    <input class="feeInput" id="feeBaseInput" inputmode="numeric" placeholder="í•­ê³µë£Œ(ì˜ˆ: 10000)" />
                    <span class="feeResultInline" id="feeResultInline">= -</span>
                  </div>
                  <div class="feeHint" id="feeHint"></div>
                </div>
              </div>

              <div class="kvItem">
                <div class="kvTitle"><span class="dot orange"></span> íŠ¹ì´ì‚¬í•­</div>
                <div class="kvValue">${escapeHtml(note || '-')}</div>
              </div>

              <div class="kvItem">
                <div class="kvTitle"><span class="dot red"></span> ê¸ˆì§€ì‚¬í•­</div>
                <div class="kvValue">${escapeHtml(ban || '-')}</div>
              </div>

              <div class="kvItem">
                <div class="kvTitle"><span class="dot gray"></span> ë¹„ê³ </div>
                <div class="kvValue">${escapeHtml(memo || '-')}</div>
              </div>
            </div>
          </div>
        `;

        setupFeeCalculator(feePct);

        setDebug(`data ì‹œíŠ¸ ë¡œë“œë¨: rows=${dataRows.length}`);

      } catch (e) {
        console.error(e);
        showError((e && e.message) ? e.message : String(e));
        setDataStatus("ì—ëŸ¬ ë°œìƒ", "warn");
      }
    }

    function setupFeeCalculator(feePct) {
      const input = document.getElementById('feeBaseInput');
      const out = document.getElementById('feeResultInline');
      const hint = document.getElementById('feeHint');
      if (!input || !out) return;

      const calc = () => {
        const base = parseNumber(input.value || '');

        if (feePct == null) {
          out.textContent = "= -";
          if (hint) hint.textContent = "ìˆ˜ìˆ˜ë£Œìœ¨ì„ Cì—´ì— 3%ì²˜ëŸ¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
          return;
        }
        if (hint) hint.textContent = "";

        if (base == null) {
          out.textContent = "= -";
          return;
        }

        const feeAmount = Math.round(base * feePct);
        out.textContent = `= ${formatNumber(feeAmount)}`;
      };

      input.addEventListener('input', calc);
      calc();
    }

    function getFromInfo() {
      const item = Office?.context?.mailbox?.item;
      if (!item) throw new Error("Office.context.mailbox.item ì´ ì—†ìŠµë‹ˆë‹¤. (ë©”ì¼ ì½ê¸° í™”ë©´ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”)");
      const fromEmail = item?.from?.emailAddress || '';
      const fromDomain = normalizeToDomain(fromEmail);
      return { fromEmail, fromDomain };
    }

    function buildGvizUrl(sheetId, sheetName) {
      const base = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      return `${base}&_ts=${Date.now()}`;
    }

    async function fetchGvizRows(url) {
      const res = await fetch(url, { method: 'GET', redirect: 'follow', cache: 'no-store' });
      if (!res.ok) {
        const body = await safeText(res);
        throw new Error(`Sheet fetch failed: HTTP ${res.status} ${res.statusText}\n\nì‘ë‹µ ì¼ë¶€:\n${(body || '').slice(0, 300)}`);
      }

      const text = await res.text();
      if (!text.includes("google.visualization") && !text.startsWith("/*O_o*/")) {
        throw new Error("gviz JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (ë¡œê·¸ì¸/ê¶Œí•œ/ì°¨ë‹¨ ê°€ëŠ¥)\n\nì‘ë‹µ ì¼ë¶€:\n" + text.slice(0, 300));
      }

      const jsonText = text.substring(47).slice(0, -2);
      const json = JSON.parse(jsonText);

      return (json.table.rows || []).map(r => (r.c || []).map(cell => {
        if (!cell) return '';
        return (cell.f != null ? cell.f : cell.v) ?? '';
      }));
    }

    async function safeText(res) {
      try { return await res.text(); } catch { return ""; }
    }

    function normalizeToDomain(value) {
      if (value == null) return '';
      let s = String(value);
      s = s.replace(/\u00A0/g, ' ').trim().toLowerCase();
      s = s.replace(/^https?:\/\//, '');
      s = s.replace(/,.*$/, '');
      s = s.replace(/\/.*$/, '');
      s = s.replace(/^[.@]+/, '');
      if (s.includes('@')) s = s.slice(s.lastIndexOf('@') + 1).trim();
      return s;
    }

    function findFirstMatchByDomainInA(rows, fromDomain) {
      const d = normalizeToDomain(fromDomain);

      for (let i = 0; i < rows.length; i++) {
        const rawKey = String(rows[i][KEY_COL] ?? '');
        const keyDomain = normalizeToDomain(rawKey);
        if (!keyDomain) continue;

        if (keyDomain === d) return { rowIndex: i, row: rows[i] };
        if (d.endsWith('.' + keyDomain) || keyDomain.endsWith('.' + d)) return { rowIndex: i, row: rows[i] };
      }
      return null;
    }

    function setDataStatus(text, tone) {
      const el = document.getElementById('dataStatus');
      el.textContent = text;
      el.classList.remove('ok', 'warn');
      if (tone) el.classList.add(tone);
    }

    function setDebug(text) {
      document.getElementById('debug').textContent = text || '';
    }

    function clearUI() {
      document.getElementById('dataCard').innerHTML = '';
      document.getElementById('debug').textContent = '';
      document.getElementById('dataStatus').textContent = '-';
    }

    function showError(msg) {
      document.getElementById('error').textContent = msg;
    }

    function clearError() {
      document.getElementById('error').textContent = '';
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // helpers
    function parsePercent(raw) {
      if (raw == null) return null;
      const s = String(raw).replace(/\s/g, '');
      if (!s) return null;
      const cleaned = s.replace('%', '');
      const n = Number(cleaned);
      if (!isFinite(n)) return null;
      return n / 100;
    }

    function formatPercent(p) {
      const n = p * 100;
      const txt = (Math.round(n * 100) / 100).toString();
      return `${txt}%`;
    }

    function parseNumber(raw) {
      if (raw == null) return null;
      const s = String(raw).replace(/[,\s]/g, '');
      if (!s) return null;
      const n = Number(s);
      if (!isFinite(n)) return null;
      return n;
    }

    function formatNumber(n) {
      try { return n.toLocaleString('ko-KR'); } catch { return String(n); }
    }
  </script>
</body>
</html>
