<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ê±°ë˜ì²˜ ì •ë³´</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    :root{
      --brand:#2b579a;
      --border:#e7e7e7;
      --muted:#6b7280;
      --bg:#ffffff;
      --card:#ffffff;
      --chip:#f7f7f8;
    }
    body { font-family: 'Segoe UI', sans-serif; padding: 14px; margin: 0; background: var(--bg); }
    .header {
      color: var(--brand);
      font-size: 16px;
      font-weight: 800;
      border-bottom: 2px solid var(--brand);
      padding-bottom: 8px;
      margin-bottom: 12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .sub { color: var(--muted); font-size: 12px; margin-top: 2px; }

    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: var(--card);
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
      margin-bottom: 12px;
    }

    .row { display:flex; justify-content:space-between; gap:12px; margin: 6px 0; font-size: 13px; }
    .label { color: var(--muted); min-width: 120px; }
    .value { font-weight: 800; color:#111827; word-break: break-all; }

    .status { display:inline-flex; align-items:center; gap:8px; font-size:12px; padding:6px 10px; border-radius: 999px; border: 1px solid var(--border); background: var(--chip); }
    .dot { width:8px; height:8px; border-radius:999px; background:#9ca3af; }
    .ok .dot{ background:#16a34a; }
    .warn .dot{ background:#f59e0b; }

    .grid {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 6px;
    }

    .field {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
    }
    .field .k { color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .field .v { font-size: 12px; font-weight: 800; color:#111827; line-height: 1.4; white-space: pre-wrap; }

    .feeWrap { margin-top: 10px; border-top: 1px dashed var(--border); padding-top: 10px; }
    .feeTop { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .chip { font-size: 12px; padding: 6px 10px; border-radius:999px; border:1px solid var(--border); background: var(--chip); color:#111827; }
    .input {
      padding: 9px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      width: 160px;
      outline: none;
    }
    .input:focus { border-color: rgba(43,87,154,0.5); box-shadow: 0 0 0 3px rgba(43,87,154,0.12); }
    .hint { color: var(--muted); font-size: 12px; margin-top: 8px; white-space: pre-wrap; }

    button {
      padding: 9px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fafafa;
      cursor: pointer;
      font-weight: 700;
      width: 100%;
    }

    .error { color: #b00020; white-space: pre-wrap; font-size: 12px; line-height: 1.4; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="header">ğŸ“Œ ê±°ë˜ì²˜ ì •ë³´</div>

  <div class="card">
    <div class="row"><div class="label">ë°œì‹ ì ì´ë©”ì¼</div><div class="value" id="fromEmail">-</div></div>
    <div class="row"><div class="label">ë°œì‹ ì ë„ë©”ì¸</div><div class="value" id="fromDomain">-</div></div>
    <div style="margin-top:10px;">
      <span class="status" id="statusPill"><span class="dot"></span><span id="statusText">ëŒ€ê¸°ì¤‘</span></span>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center;">
      <div class="label" style="font-weight:800;color:#111827;">ì¡°íšŒ ê²°ê³¼</div>
      <div style="flex:1;"></div>
      <span class="status" id="resultPill"><span class="dot"></span><span id="resultText">-</span></span>
    </div>

    <div id="fields" class="grid"></div>
  </div>

  <button id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
  <div class="error" id="error"></div>

  <script>
    // âœ… ë„ˆì˜ Apps Script ì›¹ì•± URL
    const SCRIPT_API_URL = "https://script.google.com/macros/s/AKfycbx_3xHGU585tXybxxTmF0o_RpNlyu2IXozPiaUTt0ZmedguG_goUAfmF3PzFit7ykL0/exec";

    // âœ… ìˆ˜ìˆ˜ë£Œ ì»¬ëŸ¼ëª… í›„ë³´ (í—¤ë”ê°€ ë¬´ì—‡ì´ë“  ìë™ íƒìƒ‰)
    const FEE_FIELD_CANDIDATES = ["ìˆ˜ìˆ˜ë£Œ", "fee", "commission", "ì»¤ë¯¸ì…˜", "rate"];

    // âœ… í‘œì‹œì—ì„œ ì œì™¸í•  ì»¬ëŸ¼(ì›í•˜ë©´ ì¶”ê°€)
    const HIDE_FIELDS = ["email", "ì´ë©”ì¼", "domain", "ë„ë©”ì¸"];

    // âœ… "Bì—´ë¶€í„° ë³´ì—¬ì£¼ê¸°" => recordì˜ ì²« ë²ˆì§¸ ì»¬ëŸ¼(Aì—´, key) í•­ìƒ ì œì™¸
    // Apps Script ì‘ë‹µì—ì„œ headers/recordê°€ ì˜¤ê³ , headers[0]ì´ Aì—´ì´ë¼ê³  ê°€ì •.
    const SKIP_FIRST_COLUMN = true;

    let currentFeeRate = null;   // 0.03 ê°™ì€ rate
    let currentFeeText = null;   // "3%" ê°™ì€ í‘œì‹œ í…ìŠ¤íŠ¸

    document.getElementById('btnRefresh').addEventListener('click', run);

    Office.onReady(() => {
      try {
        Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged, () => run());
      } catch (e) {
        console.error("ItemChanged handler failed:", e);
      }
      run();
    });

    async function run() {
      clearError();
      setStatus("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", "warn");
      setResult("-", "warn");
      document.getElementById("fields").innerHTML = "";

      try {
        const { fromEmail, fromDomain } = getFromInfo();
        document.getElementById('fromEmail').textContent = fromEmail || '(ì—†ìŒ)';
        document.getElementById('fromDomain').textContent = fromDomain || '(ì—†ìŒ)';

        if (!fromDomain) {
          setStatus("ë°œì‹ ì ë„ë©”ì¸ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "warn");
          return;
        }

        const json = await callScriptJsonp(fromDomain);

        if (!json.allowed) {
          setStatus("ì™„ë£Œ", "ok");
          setResult("ë“±ë¡ë˜ì§€ ì•Šì€ ë„ë©”ì¸", "warn");
          return;
        }

        if (json.matched === false) {
          setStatus("ì™„ë£Œ", "ok");
          setResult("ë“±ë¡ë¨ / data ë§¤ì¹­ ì—†ìŒ", "warn");
          return;
        }

        if (!json.record || typeof json.record !== "object") {
          setStatus("ì—ëŸ¬", "warn");
          setResult("ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜", "warn");
          throw new Error("Apps Script ì‘ë‹µì— recordê°€ ì—†ìŠµë‹ˆë‹¤.");
        }

        setStatus("ì™„ë£Œ", "ok");
        setResult("ë§¤ì¹­ë¨ âœ…", "ok");

        // âœ… ë™ì  í•„ë“œ ë Œë” (Bì—´ë¶€í„°)
        renderFields(json);

      } catch (e) {
        console.error(e);
        setStatus("ì—ëŸ¬", "warn");
        showError((e && e.message) ? e.message : String(e));
      }
    }

    function getFromInfo() {
      const item = Office?.context?.mailbox?.item;
      if (!item) throw new Error("Office.context.mailbox.item ì´ ì—†ìŠµë‹ˆë‹¤. (ë©”ì¼ ì½ê¸° í™”ë©´ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”)");
      const fromEmail = item?.from?.emailAddress || '';
      const fromDomain = normalizeToDomain(fromEmail);
      return { fromEmail, fromDomain };
    }

    function normalizeToDomain(value) {
      if (value == null) return '';
      let s = String(value);
      s = s.replace(/\u00A0/g, ' ').trim().toLowerCase();
      s = s.replace(/^https?:\/\//, '');
      s = s.replace(/,.*$/, '');
      s = s.replace(/\/.*$/, '');
      s = s.replace(/^[.@]+/, '');
      if (s.includes('@')) s = s.slice(s.lastIndexOf('@') + 1).trim();
      return s;
    }

    // âœ… JSONP í˜¸ì¶œ
    function callScriptJsonp(domain) {
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Math.random().toString(36).slice(2);
        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error("Apps Script JSONP timeout"));
        }, 12000);

        window[cbName] = (data) => { cleanup(); resolve(data); };

        const url =
          `${SCRIPT_API_URL}?domain=${encodeURIComponent(domain)}` +
          `&callback=${encodeURIComponent(cbName)}` +
          `&_ts=${Date.now()}`;

        const script = document.createElement("script");
        script.src = url;
        script.async = true;
        script.onerror = () => { cleanup(); reject(new Error("Apps Script JSONP load failed")); };

        document.head.appendChild(script);

        function cleanup() {
          clearTimeout(timeout);
          try { delete window[cbName]; } catch {}
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }
      });
    }

    function renderFields(json) {
      const record = json.record;
      const headers = Array.isArray(json.headers) ? json.headers : Object.keys(record);

      // í‘œì‹œí•  í‚¤ ëª©ë¡ ê²°ì • (Bì—´ë¶€í„°)
      let keys = headers.filter(h => String(h || '').trim() !== "");
      if (SKIP_FIRST_COLUMN && keys.length > 0) keys = keys.slice(1);

      // ìˆ¨ê¹€ í•„ë“œ ì œê±°
      keys = keys.filter(k => !HIDE_FIELDS.map(x => x.toLowerCase()).includes(String(k).toLowerCase()));

      // ìˆ˜ìˆ˜ë£Œ ì»¬ëŸ¼ ì°¾ê¸°
      const feeKey = findFeeKey(record, keys);
      const feeRaw = feeKey ? record[feeKey] : null;

      // ìˆ˜ìˆ˜ë£ŒëŠ” â€œ3%â€ í˜•íƒœë¡œ ë³´ì—¬ì£¼ê¸°
      const feeRate = parsePercentToRate(feeRaw);
      currentFeeRate = feeRate;
      currentFeeText = feeRate != null ? formatRateAsPercentText(feeRaw, feeRate) : null;

      // í•„ë“œ ë Œë”
      const container = document.getElementById("fields");
      container.innerHTML = "";

      for (const k of keys) {
        const v = record[k];

        // ìˆ˜ìˆ˜ë£Œ í•­ëª©ì€ ê³„ì‚°ê¸° í¬í•¨í•´ì„œ ë Œë”
        if (feeKey && String(k) === String(feeKey)) {
          container.appendChild(renderFeeField(k, v, feeRate));
          continue;
        }

        container.appendChild(renderPrettyField(k, v));
      }
    }

    function renderPrettyField(key, value) {
      const div = document.createElement("div");
      div.className = "field";
      div.innerHTML = `
        <div class="k">${escapeHtml(key)}</div>
        <div class="v">${escapeHtml(formatValue(value))}</div>
      `;
      return div;
    }

    function renderFeeField(key, value, feeRate) {
      const div = document.createElement("div");
      div.className = "field";

      const feeText = feeRate != null ? formatRateAsPercentText(value, feeRate) : formatValue(value);

      div.innerHTML = `
        <div class="k">${escapeHtml(key)}</div>
        <div class="v">${escapeHtml(feeText)}</div>
        <div class="feeWrap" id="feeWrap">
          <div class="feeTop">
            <span class="chip" id="feeChip">ìˆ˜ìˆ˜ë£Œ: ${escapeHtml(feeText)}</span>
            <input class="input" id="amountInput" placeholder="ê¸ˆì•¡ ì…ë ¥ (ì˜ˆ: 10000)" inputmode="numeric" />
            <span class="chip" id="resultChip">ê²°ê³¼: -</span>
          </div>
        </div>
      `;

      // feeRate ì—†ìœ¼ë©´ ê³„ì‚°ê¸° ìˆ¨ê¹€
      if (feeRate == null) {
        div.querySelector("#feeWrap").style.display = "none";
        return div;
      }

      const amountInput = div.querySelector("#amountInput");
      const resultChip = div.querySelector("#resultChip");

      amountInput.addEventListener("input", () => {
        const amount = parseMoney(amountInput.value);
        if (amount == null) {
          resultChip.textContent = "ê²°ê³¼: -";
          return;
        }
        const feeAmount = Math.round(amount * feeRate);
        resultChip.textContent = `ê²°ê³¼: ${formatMoney(feeAmount)} ( ${formatMoney(amount)} Ã— ${formatRateNumber(feeRate)}% )`;
      });

      return div;
    }

    function findFeeKey(record, keys) {
      const keyLower = keys.map(k => [k, String(k).trim().toLowerCase()]);
      // ì •í™•íˆ ì¼ì¹˜ ìš°ì„ 
      for (const cand of FEE_FIELD_CANDIDATES) {
        const c = cand.toLowerCase();
        const hit = keyLower.find(([k, kl]) => kl === c);
        if (hit) return hit[0];
      }
      // í¬í•¨ ë§¤ì¹­
      const loose = keyLower.find(([k, kl]) =>
        kl.includes("ìˆ˜ìˆ˜ë£Œ") || kl.includes("fee") || kl.includes("commission") || kl.includes("ì»¤ë¯¸ì…˜")
      );
      return loose ? loose[0] : null;
    }

    // "3%" / "0.03" / "3" -> 0.03
    function parsePercentToRate(value) {
      if (value == null) return null;
      let s = String(value).trim();
      if (!s) return null;

      if (s.includes("%")) {
        s = s.replace("%", "").trim();
        const n = Number(s.replace(/,/g, ""));
        if (Number.isFinite(n)) return n / 100;
        return null;
      }

      const n = Number(s.replace(/,/g, ""));
      if (!Number.isFinite(n)) return null;

      if (n <= 1) return n;   // 0.03
      return n / 100;         // 3 -> 0.03
    }

    // í‘œì‹œ í…ìŠ¤íŠ¸ëŠ” í•­ìƒ "3%" í˜•íƒœë¡œ
    function formatRateAsPercentText(raw, rate) {
      // rawê°€ "3%"ë©´ ê·¸ëŒ€ë¡œ
      const s = raw == null ? "" : String(raw).trim();
      if (s.includes("%")) return s.replace(/\s+/g, "");

      // ìˆ«ìë©´ rateë¡œ ê³„ì‚°í•´ì„œ 2ìë¦¬ê¹Œì§€ ì˜ˆì˜ê²Œ
      const pct = rate * 100;
      // 3.00%ë©´ "3%"ë¡œ ê¹”ë”í•˜ê²Œ
      const fixed = (Math.round(pct * 100) / 100);
      const pretty = (fixed % 1 === 0) ? String(fixed.toFixed(0)) : String(fixed);
      return `${pretty}%`;
    }

    function formatRateNumber(rate) {
      const pct = rate * 100;
      const fixed = (Math.round(pct * 100) / 100);
      return (fixed % 1 === 0) ? fixed.toFixed(0) : String(fixed);
    }

    function parseMoney(text) {
      const s = String(text || "").trim();
      if (!s) return null;
      const n = Number(s.replace(/,/g, ""));
      if (!Number.isFinite(n)) return null;
      return n;
    }

    function formatMoney(n) {
      try { return Number(n).toLocaleString("ko-KR"); }
      catch { return String(n); }
    }

    function formatValue(v) {
      if (v == null) return "";
      // ìˆ«ìì¸ë° 0.03 ê°™ì€ ê°’ì€ ê·¸ëƒ¥ ìˆ«ìë¡œ ë³´ì—¬ì¤„ ìˆ˜ ìˆìœ¼ë‹ˆ(ìˆ˜ìˆ˜ë£ŒëŠ” ë”°ë¡œ ì²˜ë¦¬)
      return String(v);
    }

    function setStatus(text, tone) {
      const pill = document.getElementById("statusPill");
      const t = document.getElementById("statusText");
      t.textContent = text;
      pill.classList.remove("ok", "warn");
      pill.classList.add(tone === "ok" ? "ok" : "warn");
    }

    function setResult(text, tone) {
      const pill = document.getElementById("resultPill");
      const t = document.getElementById("resultText");
      t.textContent = text;
      pill.classList.remove("ok", "warn");
      pill.classList.add(tone === "ok" ? "ok" : "warn");
    }

    function showError(msg) {
      document.getElementById("error").textContent = msg;
    }

    function clearError() {
      document.getElementById("error").textContent = "";
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
