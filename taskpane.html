<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ê±°ë˜ì²˜ ë§¤ì¹­ ë·°ì–´</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 15px; margin: 0; background: #fff; }
    .header { color: #2b579a; font-size: 16px; font-weight: 700; border-bottom: 2px solid #2b579a; padding-bottom: 6px; margin-bottom: 12px; }
    .box { border: 1px solid #e5e5e5; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .row { margin: 6px 0; font-size: 13px; }
    .label { color:#666; display:inline-block; width: 120px; }
    .value { font-weight: 700; }
    .ok { color: #0a7a0a; }
    .warn { color: #b36b00; }
    .err { color: #b00020; white-space: pre-wrap; font-size: 12px; }
    button { padding: 8px 10px; border-radius: 8px; border: 1px solid #ddd; background: #fafafa; cursor: pointer; }
  </style>
</head>
<body>
  <div class="header">ğŸ“© ê±°ë˜ì²˜ ë„ë©”ì¸ ë§¤ì¹­</div>

  <div class="box" id="mailBox">
    <div class="row"><span class="label">ë°œì‹ ì ì´ë©”ì¼</span> <span class="value" id="fromEmail">-</span></div>
    <div class="row"><span class="label">ë°œì‹ ì ë„ë©”ì¸</span> <span class="value" id="fromDomain">-</span></div>
  </div>

  <div class="box" id="matchBox">
    <div class="row"><span class="label">ë‹´ë‹¹ì</span> <span class="value" id="ownerName">-</span></div>
    <div class="row"><span class="label">ì§ê¸‰</span> <span class="value" id="ownerTitle">-</span></div>
    <div class="row" id="statusRow"><span class="label">ìƒíƒœ</span> <span class="value" id="statusText">ëŒ€ê¸°ì¤‘</span></div>
  </div>

  <button id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
  <div class="err" id="error" style="margin-top:10px;"></div>

  <script>
    // âœ… ë„¤ êµ¬ê¸€ ì‹œíŠ¸ ID
    const SHEET_ID = '1DW0Rl4lDhw8lfEF0lRxXWA21WHLBSLNVrOq4eCwQG4w';

    // âœ… Sheet2 ì´ë¦„(íƒ­ ì´ë¦„) ì •í™•íˆ ë§ì¶°ì¤˜
    const SHEET2_NAME = 'Sheet2';

    // gviz ì¿¼ë¦¬: íŠ¹ì • ì‹œíŠ¸ì˜ ëª¨ë“  ê°’ì„ JSONìœ¼ë¡œ
    // sheet= íƒ­ì´ë¦„ì„ ë„£ìœ¼ë©´ í•´ë‹¹ ì‹œíŠ¸ë§Œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆì–´ìš”.
    const SHEET2_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET2_NAME)}`;

    Office.onReady(() => {
      document.getElementById('btnRefresh').addEventListener('click', run);
      run();
    });

    async function run() {
      clearError();
      setStatus('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'warn');

      try {
        const { fromEmail, fromDomain } = getFromInfo();
        document.getElementById('fromEmail').textContent = fromEmail || '(ì—†ìŒ)';
        document.getElementById('fromDomain').textContent = fromDomain || '(ì—†ìŒ)';

        if (!fromDomain) {
          setStatus('ë°œì‹ ì ë„ë©”ì¸ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'warn');
          return;
        }

        // Sheet2 ë¡œë“œ í›„ ë§¤ì¹­
        const rows = await fetchGvizRows(SHEET2_URL);

        // Sheet2 ì»¬ëŸ¼ ê°€ì •: [ë„ë©”ì¸, ë‹´ë‹¹ì, ì§ê¸‰]
        const matched = findDomainRow(rows, fromDomain);

        if (!matched) {
          document.getElementById('ownerName').textContent = '-';
          document.getElementById('ownerTitle').textContent = '-';
          setStatus(`ë§¤ì¹­ ì—†ìŒ: ${fromDomain}`, 'warn');
          return;
        }

        const [domain, name, title] = matched;
        document.getElementById('ownerName').textContent = name || '-';
        document.getElementById('ownerTitle').textContent = title || '-';
        setStatus(`ë§¤ì¹­ ì„±ê³µ: ${domain}`, 'ok');

      } catch (e) {
        showError(e);
        setStatus('ì—ëŸ¬ ë°œìƒ', 'warn');
      }
    }

    function getFromInfo() {
      // Read ëª¨ë“œì—ì„œ from ì •ë³´
      const item = Office.context.mailbox.item;
      const from = item?.from;
      const fromEmail = from?.emailAddress || '';

      const fromDomain = extractDomain(fromEmail);
      return { fromEmail, fromDomain };
    }

    function extractDomain(email) {
      if (!email) return '';
      const at = email.lastIndexOf('@');
      if (at === -1) return '';
      return email.slice(at + 1).trim().toLowerCase();
    }

    async function fetchGvizRows(url) {
      // Outlook í™˜ê²½ì—ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í¬í•¨ë  ìˆ˜ ìˆì–´ follow ê¶Œì¥
      const res = await fetch(url, { method: 'GET', redirect: 'follow', cache: 'no-store' });
      if (!res.ok) throw new Error(`Sheet fetch failed: HTTP ${res.status} ${res.statusText}`);

      const text = await res.text();

      // gviz JSON ë¶€ë¶„ë§Œ ì˜ë¼ë‚´ê¸°
      const jsonText = text.substring(47).slice(0, -2);
      const json = JSON.parse(jsonText);

      // rows -> 2ì°¨ì› ë°°ì—´ë¡œ ë³€í™˜
      // row.c: ê° ì…€ {v, f} í˜•íƒœ
      const rows = (json.table.rows || []).map(r => (r.c || []).map(cell => {
        if (!cell) return '';
        return (cell.f != null ? cell.f : cell.v) ?? '';
      }));

      // ì²« í–‰ì´ í—¤ë”ë¼ë©´ ì œê±°í•˜ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬ ê°€ëŠ¥
      // (í•„ìš”í•˜ë©´ ì£¼ì„ í•´ì œ)
      // if (rows.length && rows[0][0] && String(rows[0][0]).includes('ë„ë©”ì¸')) rows.shift();

      return rows;
    }

    function findDomainRow(rows, domain) {
      const d = domain.toLowerCase();
      for (const row of rows) {
        const key = String(row[0] ?? '').trim().toLowerCase();
        if (!key) continue;

        // ì •í™•íˆ ì¼ì¹˜
        if (key === d) return [key, row[1], row[2]];

        // "test.com"ì´ rowì— "mail.test.com"ì²˜ëŸ¼ ë“¤ì–´ê°„ ê²½ìš°ê¹Œì§€ í—ˆìš©í•˜ê³  ì‹¶ë‹¤ë©´:
        // if (d.endsWith(key)) return [key, row[1], row[2]];
      }
      return null;
    }

    function setStatus(text, tone) {
      const el = document.getElementById('statusText');
      el.textContent = text;
      el.classList.remove('ok', 'warn');
      if (tone) el.classList.add(tone);
    }

    function showError(e) {
      console.error(e);
      const msg = (e && e.message) ? e.message : String(e);
      document.getElementById('error').textContent = `ì—ëŸ¬:\n${msg}`;
    }

    function clearError() {
      document.getElementById('error').textContent = '';
    }
  </script>
</body>
</html>
