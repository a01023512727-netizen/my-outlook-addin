<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <!-- Outlook 2016(IE WebView) í˜¸í™˜ -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>ê±°ë˜ì²˜ ì •ë³´</title>

  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <style>
    /* âœ… CSS ë³€ìˆ˜(:root) ì œê±° -> IE11ì—ì„œë„ ì•ˆì •ì ìœ¼ë¡œ ë³´ì´ê²Œ */
    body { font-family: "Segoe UI", Arial, sans-serif; padding: 14px; margin: 0; background: #ffffff; }

    .header {
      color: #2b579a;
      font-size: 16px;
      font-weight: 800;
      border-bottom: 2px solid #2b579a;
      padding-bottom: 8px;
      margin-bottom: 12px;
      /* flexëŠ” IE11 ê°€ëŠ¥, gapì€ ë¶ˆì•ˆì • -> marginìœ¼ë¡œ ëŒ€ì²´ */
      display: -ms-flexbox;
      display: flex;
      -ms-flex-align: center;
      align-items: center;
    }
    .header .ico { margin-right: 8px; }

    .sub { color: #6b7280; font-size: 12px; margin-top: 2px; }

    .card {
      border: 1px solid #e7e7e7;
      border-radius: 14px;
      padding: 12px;
      background: #ffffff;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
      margin-bottom: 12px;
    }

    .row {
      display: -ms-flexbox;
      display: flex;
      -ms-flex-pack: justify;
      justify-content: space-between;
      margin: 6px 0;
      font-size: 13px;
    }
    .label { color: #6b7280; min-width: 120px; }
    .value { font-weight: 800; color: #111827; word-break: break-all; }

    .status {
      display: inline-block;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e7e7e7;
      background: #f7f7f8;
      color: #111827;
    }
    .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #9ca3af;
      margin-right: 6px;
      vertical-align: middle;
    }
    .okDot { background: #16a34a !important; }
    .warnDot { background: #f59e0b !important; }

    .grid { margin-top: 6px; }
    .field {
      border: 1px solid #e7e7e7;
      border-radius: 12px;
      padding: 10px 12px;
      background: #ffffff;
      margin-bottom: 10px;
    }
    .field .k { color: #6b7280; font-size: 12px; margin-bottom: 6px; }
    .field .v { font-size: 12px; font-weight: 800; color: #111827; line-height: 1.4; white-space: pre-wrap; }

    .feeWrap { margin-top: 10px; border-top: 1px dashed #e7e7e7; padding-top: 10px; }
    .feeTop { }
    .chip {
      display: inline-block;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e7e7e7;
      background: #f7f7f8;
      color: #111827;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    .input {
      padding: 9px 10px;
      border: 1px solid #e7e7e7;
      border-radius: 10px;
      font-size: 13px;
      width: 160px;
      outline: none;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    .input:focus {
      border-color: rgba(43,87,154,0.5);
      box-shadow: 0 0 0 3px rgba(43,87,154,0.12);
    }

    button {
      padding: 9px 12px;
      border-radius: 10px;
      border: 1px solid #e7e7e7;
      background: #fafafa;
      cursor: pointer;
      font-weight: 700;
      width: 100%;
    }

    .error { color: #b00020; white-space: pre-wrap; font-size: 12px; line-height: 1.4; margin-top: 10px; }
  </style>
</head>

<body>
  <div class="header"><span class="ico">ğŸ“Œ</span>ê±°ë˜ì²˜ ì •ë³´</div>

  <div class="card">
    <div class="row"><div class="label">ë°œì‹ ì ì´ë©”ì¼</div><div class="value" id="fromEmail">-</div></div>
    <div class="row"><div class="label">ë°œì‹ ì ë„ë©”ì¸</div><div class="value" id="fromDomain">-</div></div>
    <div style="margin-top:10px;">
      <span class="status" id="statusPill"><span class="dot" id="statusDot"></span><span id="statusText">ëŒ€ê¸°ì¤‘</span></span>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center;">
      <div class="label" style="font-weight:800;color:#111827;">ì¡°íšŒ ê²°ê³¼</div>
      <div style="flex:1;"></div>
      <span class="status" id="resultPill"><span class="dot" id="resultDot"></span><span id="resultText">-</span></span>
    </div>

    <div id="fields" class="grid"></div>
  </div>

  <button id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
  <div class="error" id="error"></div>

  <script>
    /* =========================
       âœ… Outlook 2016 í˜¸í™˜ íŒ¨ì¹˜
       - ES5ë§Œ ì‚¬ìš©(IE11 ê¸°ì¤€)
       - async/await, Promise, const/let, for..of, template literal, replaceAll ì œê±°
       - optional chaining ì œê±°
       - JSONPëŠ” ì½œë°± ë°©ì‹
    ========================= */

    // âœ… ë„ˆì˜ Apps Script ì›¹ì•± URL
    var SCRIPT_API_URL = "https://script.google.com/macros/s/AKfycbx_3xHGU585tXybxxTmF0o_RpNlyu2IXozPiaUTt0ZmedguG_goUAfmF3PzFit7ykL0/exec";

    // âœ… ìˆ˜ìˆ˜ë£Œ ì»¬ëŸ¼ëª… í›„ë³´
    var FEE_FIELD_CANDIDATES = ["ìˆ˜ìˆ˜ë£Œ", "fee", "commission", "ì»¤ë¯¸ì…˜", "rate"];

    // âœ… í‘œì‹œì—ì„œ ì œì™¸í•  ì»¬ëŸ¼
    var HIDE_FIELDS = ["email", "ì´ë©”ì¼", "domain", "ë„ë©”ì¸"];

    // âœ… "Bì—´ë¶€í„° ë³´ì—¬ì£¼ê¸°"
    var SKIP_FIRST_COLUMN = true;

    var currentFeeRate = null;   // 0.03 ê°™ì€ rate
    var currentFeeText = null;   // "3%" ê°™ì€ í‘œì‹œ í…ìŠ¤íŠ¸

    var btn = document.getElementById("btnRefresh");
    if (btn) btn.onclick = function () { run(); };

    // Office.onReadyê°€ ì—†ëŠ” êµ¬ë²„ì „ ëŒ€ë¹„ (Office.initialize)
    function boot() {
      try {
        // ItemChangedê°€ ì§€ì›ë˜ëŠ” ê²½ìš°ë§Œ
        if (Office && Office.context && Office.context.mailbox && Office.context.mailbox.addHandlerAsync) {
          try {
            Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged, function () { run(); });
          } catch (e1) {
            // Outlook 2016 ì¼ë¶€ í™˜ê²½ì—ì„œ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ
            // consoleì€ ë‚¨ê²¨ë„ ë¨
            try { console.error("ItemChanged handler failed:", e1); } catch (ignore1) {}
          }
        }
      } catch (e2) {}

      run();
    }

    if (typeof Office !== "undefined") {
      if (Office.onReady) {
        Office.onReady(function () { boot(); });
      } else {
        Office.initialize = function () { boot(); };
      }
    } else {
      // office.jsê°€ ëŠ¦ê²Œ ë¡œë“œë˜ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„
      setTimeout(function () {
        try { boot(); } catch (e3) {}
      }, 500);
    }

    function run() {
      clearError();
      setStatus("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", "warn");
      setResult("-", "warn");
      var fields = document.getElementById("fields");
      if (fields) fields.innerHTML = "";

      var fromInfo;
      try {
        fromInfo = getFromInfo();
      } catch (e0) {
        setStatus("ì—ëŸ¬", "warn");
        showError((e0 && e0.message) ? e0.message : String(e0));
        return;
      }

      var fromEmail = fromInfo.fromEmail;
      var fromDomain = fromInfo.fromDomain;

      document.getElementById("fromEmail").innerHTML = escapeHtml(fromEmail || "(ì—†ìŒ)");
      document.getElementById("fromDomain").innerHTML = escapeHtml(fromDomain || "(ì—†ìŒ)");

      if (!fromDomain) {
        setStatus("ë°œì‹ ì ë„ë©”ì¸ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "warn");
        return;
      }

      // âœ… JSONP ì½œë°± ë°©ì‹ (Promise ì œê±°)
      callScriptJsonp(fromDomain,
        function (json) {
          try {
            handleJson(json);
          } catch (e1) {
            setStatus("ì—ëŸ¬", "warn");
            setResult("ì‘ë‹µ ì²˜ë¦¬ ì˜¤ë¥˜", "warn");
            showError((e1 && e1.message) ? e1.message : String(e1));
          }
        },
        function (err) {
          setStatus("ì—ëŸ¬", "warn");
          showError((err && err.message) ? err.message : String(err));
        }
      );
    }

    function handleJson(json) {
      if (!json || typeof json !== "object") {
        setStatus("ì—ëŸ¬", "warn");
        setResult("ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜", "warn");
        throw new Error("Apps Script ì‘ë‹µì´ ë¹„ì •ìƒì…ë‹ˆë‹¤.");
      }

      if (!json.allowed) {
        setStatus("ì™„ë£Œ", "ok");
        setResult("ë“±ë¡ë˜ì§€ ì•Šì€ ë„ë©”ì¸", "warn");
        return;
      }

      if (json.matched === false) {
        setStatus("ì™„ë£Œ", "ok");
        setResult("ë“±ë¡ë¨ / data ë§¤ì¹­ ì—†ìŒ", "warn");
        return;
      }

      if (!json.record || typeof json.record !== "object") {
        setStatus("ì—ëŸ¬", "warn");
        setResult("ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜", "warn");
        throw new Error("Apps Script ì‘ë‹µì— recordê°€ ì—†ìŠµë‹ˆë‹¤.");
      }

      setStatus("ì™„ë£Œ", "ok");
      setResult("ë§¤ì¹­ë¨ âœ…", "ok");

      renderFields(json);
    }

    function getFromInfo() {
      var item = null;
      try {
        if (Office && Office.context && Office.context.mailbox) {
          item = Office.context.mailbox.item;
        }
      } catch (e) {}

      if (!item) throw new Error("Office.context.mailbox.item ì´ ì—†ìŠµë‹ˆë‹¤. (ë©”ì¼ ì½ê¸° í™”ë©´ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”)");

      var fromEmail = "";
      try {
        if (item.from && item.from.emailAddress) fromEmail = item.from.emailAddress;
      } catch (e2) {}

      var fromDomain = normalizeToDomain(fromEmail);
      return { fromEmail: fromEmail, fromDomain: fromDomain };
    }

    function normalizeToDomain(value) {
      if (value == null) return "";
      var s = String(value);
      s = s.replace(/\u00A0/g, " ").replace(/^\s+|\s+$/g, "").toLowerCase();
      s = s.replace(/^https?:\/\//, "");
      s = s.replace(/,.*$/, "");
      s = s.replace(/\/.*$/, "");
      s = s.replace(/^[.@]+/, "");
      if (s.indexOf("@") >= 0) s = s.slice(s.lastIndexOf("@") + 1).replace(/^\s+|\s+$/g, "");
      return s;
    }

    // âœ… JSONP í˜¸ì¶œ (ì½œë°± ë°©ì‹)
    function callScriptJsonp(domain, onSuccess, onError) {
      var cbName = "cb_" + Math.random().toString(36).slice(2);
      var done = false;

      var timeout = setTimeout(function () {
        cleanup();
        if (!done) {
          done = true;
          onError(new Error("Apps Script JSONP timeout"));
        }
      }, 12000);

      window[cbName] = function (data) {
        if (done) return;
        done = true;
        cleanup();
        onSuccess(data);
      };

      var url =
        SCRIPT_API_URL +
        "?domain=" + encodeURIComponent(domain) +
        "&callback=" + encodeURIComponent(cbName) +
        "&_ts=" + (new Date().getTime());

      var script = document.createElement("script");
      script.src = url;
      script.async = true;

      script.onerror = function () {
        cleanup();
        if (!done) {
          done = true;
          onError(new Error("Apps Script JSONP load failed"));
        }
      };

      document.getElementsByTagName("head")[0].appendChild(script);

      function cleanup() {
        clearTimeout(timeout);
        try { window[cbName] = null; delete window[cbName]; } catch (e1) {}
        try { if (script && script.parentNode) script.parentNode.removeChild(script); } catch (e2) {}
      }
    }

    function renderFields(json) {
      var record = json.record;

      // headers ìš°ì„ , ì—†ìœ¼ë©´ recordì˜ í‚¤ë¥¼ ëŒ€ì¶© ì‚¬ìš©
      var headers = [];
      if (json.headers && Object.prototype.toString.call(json.headers) === "[object Array]") {
        headers = json.headers;
      } else {
        // Object.keysëŠ” IE11 ê°€ëŠ¥í•˜ì§€ë§Œ ì•ˆì „í•˜ê²Œ for..in ì‚¬ìš©
        for (var kk in record) {
          if (record.hasOwnProperty(kk)) headers.push(kk);
        }
      }

      // í‘œì‹œí•  í‚¤ ëª©ë¡ ê²°ì • (Bì—´ë¶€í„°)
      var keys = [];
      for (var i = 0; i < headers.length; i++) {
        var h = headers[i];
        var hs = String(h || "").replace(/^\s+|\s+$/g, "");
        if (hs !== "") keys.push(h);
      }
      if (SKIP_FIRST_COLUMN && keys.length > 0) keys = keys.slice(1);

      // ìˆ¨ê¹€ í•„ë“œ ì œê±°
      var hideLower = [];
      for (var j = 0; j < HIDE_FIELDS.length; j++) hideLower.push(String(HIDE_FIELDS[j]).toLowerCase());

      var filtered = [];
      for (var k = 0; k < keys.length; k++) {
        var key = keys[k];
        var kl = String(key).toLowerCase();
        if (indexOfArray(hideLower, kl) === -1) filtered.push(key);
      }
      keys = filtered;

      // ìˆ˜ìˆ˜ë£Œ ì»¬ëŸ¼ ì°¾ê¸°
      var feeKey = findFeeKey(record, keys);
      var feeRaw = feeKey ? record[feeKey] : null;

      // ìˆ˜ìˆ˜ë£Œ í‘œì‹œ/ê³„ì‚°ìš©
      var feeRate = parsePercentToRate(feeRaw);
      currentFeeRate = feeRate;
      currentFeeText = (feeRate != null) ? formatRateAsPercentText(feeRaw, feeRate) : null;

      // ë Œë”
      var container = document.getElementById("fields");
      container.innerHTML = "";

      for (var x = 0; x < keys.length; x++) {
        var key2 = keys[x];
        var v = record[key2];

        if (feeKey && String(key2) === String(feeKey)) {
          container.appendChild(renderFeeField(key2, v, feeRate));
        } else {
          container.appendChild(renderPrettyField(key2, v));
        }
      }
    }

    function renderPrettyField(key, value) {
      var div = document.createElement("div");
      div.className = "field";
      div.innerHTML =
        '<div class="k">' + escapeHtml(key) + '</div>' +
        '<div class="v">' + escapeHtml(formatValue(value)) + '</div>';
      return div;
    }

    function renderFeeField(key, value, feeRate) {
      var div = document.createElement("div");
      div.className = "field";

      var feeText = (feeRate != null) ? formatRateAsPercentText(value, feeRate) : formatValue(value);

      div.innerHTML =
        '<div class="k">' + escapeHtml(key) + '</div>' +
        '<div class="v">' + escapeHtml(feeText) + '</div>' +
        '<div class="feeWrap" id="feeWrap">' +
          '<div class="feeTop">' +
            '<span class="chip" id="feeChip">ìˆ˜ìˆ˜ë£Œ: ' + escapeHtml(feeText) + '</span>' +
            '<input class="input" id="amountInput" placeholder="ê¸ˆì•¡ ì…ë ¥ (ì˜ˆ: 10000)" />' +
            '<span class="chip" id="resultChip">ê²°ê³¼: -</span>' +
          '</div>' +
        '</div>';

      if (feeRate == null) {
        // ê³„ì‚°ê¸° ìˆ¨ê¹€
        try { div.querySelector("#feeWrap").style.display = "none"; } catch (e) {}
        return div;
      }

      var amountInput = div.querySelector("#amountInput");
      var resultChip = div.querySelector("#resultChip");

      amountInput.oninput = function () {
        var amount = parseMoney(amountInput.value);
        if (amount == null) {
          resultChip.innerHTML = "ê²°ê³¼: -";
          return;
        }
        var feeAmount = Math.round(amount * feeRate);
        resultChip.innerHTML =
          "ê²°ê³¼: " + escapeHtml(formatMoney(feeAmount)) +
          " ( " + escapeHtml(formatMoney(amount)) + " Ã— " + escapeHtml(formatRateNumber(feeRate)) + "% )";
      };

      return div;
    }

    function findFeeKey(record, keys) {
      // ì •í™•íˆ ì¼ì¹˜ ìš°ì„ 
      for (var i = 0; i < FEE_FIELD_CANDIDATES.length; i++) {
        var cand = String(FEE_FIELD_CANDIDATES[i]).toLowerCase();
        for (var j = 0; j < keys.length; j++) {
          var k = keys[j];
          var kl = String(k).replace(/^\s+|\s+$/g, "").toLowerCase();
          if (kl === cand) return k;
        }
      }

      // í¬í•¨ ë§¤ì¹­
      for (var x = 0; x < keys.length; x++) {
        var kk = keys[x];
        var kll = String(kk).toLowerCase();
        if (kll.indexOf("ìˆ˜ìˆ˜ë£Œ") >= 0 || kll.indexOf("fee") >= 0 || kll.indexOf("commission") >= 0 || kll.indexOf("ì»¤ë¯¸ì…˜") >= 0) {
          return kk;
        }
      }

      return null;
    }

    // "3%" / "0.03" / "3" -> 0.03
    function parsePercentToRate(value) {
      if (value == null) return null;
      var s = String(value).replace(/^\s+|\s+$/g, "");
      if (!s) return null;

      if (s.indexOf("%") >= 0) {
        s = s.replace("%", "").replace(/^\s+|\s+$/g, "");
        var n1 = Number(s.replace(/,/g, ""));
        if (isFiniteNumber(n1)) return n1 / 100;
        return null;
      }

      var n = Number(s.replace(/,/g, ""));
      if (!isFiniteNumber(n)) return null;

      if (n <= 1) return n;   // 0.03
      return n / 100;         // 3 -> 0.03
    }

    // í‘œì‹œ í…ìŠ¤íŠ¸ëŠ” í•­ìƒ "3%" í˜•íƒœë¡œ
    function formatRateAsPercentText(raw, rate) {
      var s = (raw == null) ? "" : String(raw).replace(/^\s+|\s+$/g, "");
      if (s.indexOf("%") >= 0) return s.replace(/\s+/g, "");

      var pct = rate * 100;
      var fixed = (Math.round(pct * 100) / 100);
      var pretty = (fixed % 1 === 0) ? String(fixed.toFixed(0)) : String(fixed);
      return pretty + "%";
    }

    function formatRateNumber(rate) {
      var pct = rate * 100;
      var fixed = (Math.round(pct * 100) / 100);
      return (fixed % 1 === 0) ? fixed.toFixed(0) : String(fixed);
    }

    function parseMoney(text) {
      var s = String(text || "").replace(/^\s+|\s+$/g, "");
      if (!s) return null;
      var n = Number(s.replace(/,/g, ""));
      if (!isFiniteNumber(n)) return null;
      return n;
    }

    function formatMoney(n) {
      try {
        // IE11ë„ toLocaleString ë™ì‘í•˜ì§€ë§Œ, í™˜ê²½ì— ë”°ë¼ ì˜ˆì™¸ ê°€ëŠ¥
        return Number(n).toLocaleString("ko-KR");
      } catch (e) {
        return String(n);
      }
    }

    function formatValue(v) {
      if (v == null) return "";
      return String(v);
    }

    function setStatus(text, tone) {
      var t = document.getElementById("statusText");
      var dot = document.getElementById("statusDot");
      if (t) t.innerHTML = escapeHtml(text);

      if (dot) {
        dot.className = "dot " + (tone === "ok" ? "okDot" : "warnDot");
      }
    }

    function setResult(text, tone) {
      var t = document.getElementById("resultText");
      var dot = document.getElementById("resultDot");
      if (t) t.innerHTML = escapeHtml(text);

      if (dot) {
        dot.className = "dot " + (tone === "ok" ? "okDot" : "warnDot");
      }
    }

    function showError(msg) {
      var el = document.getElementById("error");
      if (el) el.innerHTML = escapeHtml(msg);
    }

    function clearError() {
      var el = document.getElementById("error");
      if (el) el.innerHTML = "";
    }

    function escapeHtml(s) {
      var str = String(s);
      // replaceAll ëŒ€ì‹  ì •ê·œì‹
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function isFiniteNumber(n) {
      return typeof n === "number" && isFinite(n);
    }

    function indexOfArray(arr, value) {
      for (var i = 0; i < arr.length; i++) {
        if (arr[i] === value) return i;
      }
      return -1;
    }
  </script>
</body>
</html>
